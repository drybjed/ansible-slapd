---

# ---- OpenLDAP BaseDN configuration ----

# DNS domain name which will be used for OpenLDAP BaseDN
slapd_domain: '{{ ansible_domain }}'

# BaseDN value of the OpenLDAP server
slapd_basedn: '{{ "dc=" + slapd_domain.split(".") | join(",dc=") }}'

# Specify database backend to use
slapd_backend: '{{ "hdb" if (ansible_distribution_release in [ "wheezy", "precise" ])
                         else "mdb" }}'

# Length of passwords set on administrator accounts
slapd_password_length: '128'

# Log level (see slapd-config(5) for detauls)
slapd_log_level: 'none'

# Default services enabled in /etc/default/slapd (change requires restart)
slapd_default_services: [ 'ldap:///', 'ldaps:///', 'ldapi:///' ]


# ---- Network access to OpenLDAP server ----

# Lists of hosts or CIDR networks which are allowed to access slapd service. If
# none are specified, any host can connect to OpenLDAP server
slapd_allow: []
slapd_group_allow: []
slapd_host_allow: []

# Default setting in /etc/hosts.allow if no hosts are specified in above lists
slapd_tcpwrappers_default: 'ALL'

# Deny anonymous bind to the server by default and require authentication.
# Set to True to allow anonymous bind.
slapd_anonymous_bind: False


# ---- slapd system configuration ----

# List of system groups to grant to 'openldap' user. 'ssl-cert' group is
# required for access to private keys
slapd_append_groups: [ 'ssl-cert' ]

# Create snapshots of LDAP database periodically
slapd_snapshot: True

# Snapshot period: daily, weekly
slapd_snapshot_period: 'weekly'


# ---- PKI / TLS and certificates ----

# Enable or disable support for certificates (using debops.pki)
slapd_pki: True

# Base PKI directory
slapd_pki_path: '{% if (ansible_local is defined and ansible_local.pki is defined) %}{{ ansible_local.pki.base_path }}{% else %}/etc/pki{% endif %}'

# Default PKI realm used by OpenLDAP
slapd_pki_realm: '{% if (ansible_local is defined and ansible_local.pki is defined) %}{{ ansible_local.pki.realm }}{% else %}system{% endif %}'

# Default CA certificate, server certificate and key used by OpenLDAP server
slapd_pki_ca: 'CA.crt'
slapd_pki_crt: 'default.crt'
slapd_pki_key: 'default.key'
slapd_pki_dhparam: 'dhparam.pem'

# TLS cipher suite required by the server
slapd_pki_ciphers: 'SECURE256:-VERS-SSL3.0'


# ---- Administrator accounts & passwords ----

# slapd passwords cannot be directly generated by Ansible; they are handled in
# separate tasks during runtime. Here you can change the location of passwords
# in debops.secret storage if needed, for example to point several slapd
# servers to the same set of passwords.

# ==== cn=admin,cn=config ====

# Base path to BaseDN administrator password
slapd_config_admin_basepw: '{{ secret + "/credentials/" + ansible_fqdn + "/slapd/cn=config/cn=admin,cn=config" }}'

# Plaintext password of BaseDN administrator
slapd_config_admin_password: '{{ slapd_config_admin_basepw + ".password" }}'

# Hash of BaseDN administrator password
slapd_config_admin_hash: '{{ slapd_config_admin_basepw + ".hash" }}'

# ==== BaseDN administrator ====

# Distinguished Name of main administrator account
slapd_basedn_admin: '{{ "cn=admin," + slapd_basedn }}'

# Base path to BaseDN administrator password
slapd_basedn_admin_basepw: '{{ secret + "/slapd/credentials/" + slapd_basedn + "/" + slapd_basedn_admin }}'

# Plaintext password of BaseDN administrator
slapd_basedn_admin_password: '{{ slapd_basedn_admin_basepw + ".password" }}'

# Hash of BaseDN administrator password
slapd_basedn_admin_hash: '{{ slapd_basedn_admin_basepw + ".hash" }}'

# Location of the Ansible password file for LDAP admin access
# (see 'debops.secret' role for more details)
slapd_basedn_admin_ansible_password: '{{ secret_ldap_admin_password }}'


# ---- ldapscripts configuration ----

# See templates/etc/ldapscripts/ldapscripts.conf for more information about
# these variables

# Enable ldapscripts support (install and configure ldapscripts)
slapd_ldapscripts: False

# LDAP server to configure
slapd_ldapscripts_server: 'ldap://localhost'

# Default BaseDN to use in ldapscripts
slapd_ldapscripts_suffix: '{{ slapd_basedn }}'

# Oranizational Units for Groups, Users and Machines
slapd_ldapscripts_gsuffix: 'ou=Groups'
slapd_ldapscripts_usuffix: 'ou=Users'
slapd_ldapscripts_msuffix: 'ou=Machines'

# BindDN admin account and file with password
slapd_ldapscripts_binddn: '{{ slapd_basedn_admin }}'
slapd_ldapscripts_bindpwdfile: '/etc/ldapscripts/ldapscripts.passwd'

# Where to look for admin account password
slapd_ldapscripts_password_lookup: '{{ slapd_basedn_admin_password }}'

# Groups, User and Machine  start IDs
slapd_ldapscripts_gidstart: '10000'
slapd_ldapscripts_uidstart: '10000'
slapd_ldapscripts_midstart: '20000'

# Group membership management
# Possible values: posixGroup, groupOfNames, groupOfUniqueNames
slapd_ldapscripts_gclass: 'posixGroup'
slapd_ldapscripts_gdummymember: 'uid=dummy,$USUFFIX,$SUFFIX'

# User password generation
slapd_ldapscripts_passwordgen: 'pwgen'


slapd_ldap_server_id: [ '0' ]

slapd_ldap_mirrormode: True

slapd_ldap_mirrormode_provider: ''

slapd_ldap_mirrormode_name: 'mirrormode'
slapd_ldap_mirrormode_description: 'Syncrepl user for mirrormode operation'
slapd_ldap_mirrormode_dn: '{{ "cn=" + slapd_ldap_mirrormode_name + "," + slapd_basedn }}'
slapd_ldap_mirrormode_basepw: '{{ secret + "/slapd/credentials/" + slapd_basedn + "/" + slapd_ldap_mirrormode_dn + ".password" }}'


slapd_ldap_mirrormode_pw_command: "openssl dgst -sha1 -binary | openssl enc -base64 | awk '{print \"{SHA}\"$0}'"

slapd_ldap_mirrormode_pw: '{{ lookup("pipe", "echo -n " + lookup("password", slapd_ldap_mirrormode_basepw + " length=48") + " | " + slapd_ldap_mirrormode_pw_command) }}'

#slapd_ldap_mirrormode_pw: '{{ "{SSHA}" + lookup("password", slapd_ldap_mirrormode_basepw +
#                              ".password encrypt=sha512_crypt length=48") }}'

# ---- Custom LDAP schema ----

# These files will be automatically loaded into cn=config configuration
# database by a helper script. You need to specify absolute paths to *.ldif
# files. Default set can be found in '/etc/ldap/schema/'
slapd_ldap_schema:

    # Additional attributes and classes for LDAP Name Service
  - '/usr/local/etc/ldap/schema/ldapns.ldif'

    # Support for SSH Public Key lookup in LDAP
  - '/usr/local/etc/ldap/schema/openssh-lpk.ldif'


# ---- LDAP index configuration ----

# List of index entries configured on the server
slapd_ldap_index: '{{ slapd_ldap_index_default }}'

# Default list of indices
slapd_ldap_index_default:

  - 'objectClass eq'
  - 'cn eq,pres'
  - 'gn eq,pres'
  - 'sn eq,pres'
  - 'uid eq'
  - 'uidNumber eq'
  - 'gidNumber eq'
  - 'memberUid eq'
  - 'authorizedService eq'
  - 'host eq'
  - 'entryCSN eq'
  - 'entryUUID eq'


# ---- LDAP connection security ----

# List of security rules enabled on the OpenLDAP server
slapd_ldap_security: '{{ slapd_ldap_security_default }}'

# Default security rules (require TLS for all connections)
slapd_ldap_security_default:

  - 'simple_bind=128'
  - 'update_ssf=128'
  - 'ssf=128'
  - 'tls=128'


# ---- LDAP Access Control List ----

# List of olcAccess attributes configured on the server
slapd_ldap_access_control_list: '{{ slapd_ldap_access_control_list_default }}'

# Default LDAP ACL. Order of entries is important!
slapd_ldap_access_control_list_default:

  - 'to attrs=userPassword,shadowLastChange
     by tls_ssf=128 ssf=128 self write
     by tls_ssf=128 ssf=128 anonymous auth
     by tls_ssf=128 ssf=128 dn="{{ slapd_basedn_admin }}" write
     by * none'

  - 'to attrs=uid,uidNumber,gidNumber,homeDirectory,loginShell
     by tls_ssf=128 ssf=128 self read
     by tls_ssf=128 ssf=128 dn="{{ slapd_basedn_admin }}" write
     by tls_ssf=128 ssf=128 users read'

  - 'to dn.base=""
     by tls_ssf=128 ssf=128 * read'

  - 'to *
     by tls_ssf=128 ssf=128 self read
     by tls_ssf=128 ssf=128 dn.subtree="ou=Machines,{{ slapd_basedn }}" read
     by tls_ssf=128 ssf=128 dn="{{ slapd_basedn_admin }}" write
     {{ ("by tls_ssf=128 ssf=128 dn=\"" + slapd_ldap_mirrormode_dn + "\" read")
        if slapd_ldap_mirrormodea|d() else "" }}
     by * none'

